---
import Layout from '../../layouts/Layout.astro';
import Container from '../../components/Layout/Container.astro';
import Heading from '../../components/UI/Heading.astro';
import Paragraph from '../../components/UI/Paragraph.astro';
import TableOfContents from '../../components/UI/TableOfContents.astro';
import { getCollection, type CollectionEntry } from 'astro:content';
import { Image } from 'astro:assets';

// MDX component imports
import VideoPlayer from '../../components/MDX/VideoPlayer.astro';
import ImageWithCaption from '../../components/MDX/ImageWithCaption.astro';
import CustomImage from '../../components/MDX/CustomImage.astro';
import List from '../../components/MDX/List.astro';

export async function getStaticPaths() {
  const blogPosts = await getCollection('blog', ({ data }) => {
    return data.isPublished !== false;
  });

  return blogPosts.map(post => ({
    params: { slug: post.slug },
    props: { post }
  }));
}

type Props = {
  post: CollectionEntry<'blog'>;
};

const { post } = Astro.props;
const { Content, headings } = await post.render();

// Format date
const date = new Date(post.data.publishedAt);
const formattedDate = date.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

// Extract headings for table of contents
const tocHeadings = headings.map(heading => ({
  text: heading.text,
  slug: heading.slug,
  level: heading.depth
}));

// Structured data for SEO
const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: post.data.title,
  description: post.data.summary,
  image: post.data.image || 'https://judetejada.com/banner.png',
  datePublished: post.data.publishedAt,
  dateModified: post.data.publishedAt,
  author: {
    '@type': 'Person',
    name: 'Jude Tejada',
    url: 'https://judetejada.com'
  },
  publisher: {
    '@type': 'Person',
    name: 'Jude Tejada',
    url: 'https://judetejada.com'
  },
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': `https://judetejada.com/blog/${post.slug}`
  },
  url: `https://judetejada.com/blog/${post.slug}`,
  keywords: post.data.labels
    ? post.data.labels.join(', ')
    : 'web development, programming, technology'
};
---

<Layout
  title={post.data.title}
  description={post.data.summary}
  canonical={`https://judetejada.com/blog/${post.slug}`}
>
  <script type='application/ld+json' set:html={JSON.stringify(structuredData)}
  ></script>

  <Container>
    <div class='py-20'>
      {
        post.data.image && (
          <div class='w-full -mx-4 sm:-mx-6 lg:-mx-8 mb-8'>
            <img
              src={post.data.image}
              alt={post.data.title}
              class='w-full h-64 sm:h-80 md:h-96 object-cover'
            />
          </div>
        )
      }

      <header class='mb-16 text-center max-w-4xl mx-auto'>
        <div class='p-8'>
          <Heading as='h1' extraClasses='mb-4'>
            {post.data.title}
          </Heading>

          <div
            class='flex items-center justify-center gap-2 text-gray-600 mb-6'
          >
            <svg
              class='w-4 h-4'
              fill='none'
              stroke='currentColor'
              viewBox='0 0 24 24'
            >
              <path
                stroke-linecap='round'
                stroke-linejoin='round'
                stroke-width='2'
                d='M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z'
              ></path>
            </svg>
            <time datetime={post.data.publishedAt}>{formattedDate}</time>
          </div>

          {
            post.data.labels && post.data.labels.length > 0 && (
              <div class='flex flex-wrap justify-center gap-2'>
                {post.data.labels.map(label => (
                  <span class='inline-block bg-gradient-to-r from-blue-500 to-blue-600 text-white text-sm px-3 py-1.5 rounded-full shadow-sm hover:shadow-md transition-shadow'>
                    {label}
                  </span>
                ))}
              </div>
            )
          }
        </div>
      </header>

      <!-- Two-column layout for tablet and desktop -->
      <div class='flex gap-8 max-w-6xl mx-auto'>
        <!-- Main Content -->
        <main class='flex-1 min-w-0'>
          <article class='prose prose-lg max-w-none'>
            <Content
              components={{
                Image: CustomImage,
                VideoPlayer,
                ImageWithCaption,
                List
              }}
            />
          </article>
        </main>

        <!-- Table of Contents (visible on tablet and desktop) -->
        <aside class='hidden lg:block w-64 flex-shrink-0'>
          <TableOfContents headings={tocHeadings} />
        </aside>
      </div>
    </div>
  </Container>
</Layout>
